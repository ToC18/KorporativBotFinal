<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á–µ—Ç –ø–æ –æ–ø—Ä–æ—Å—É: {{ poll.title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 960px;
            margin: 40px auto;
            padding: 0 20px;
            background-color: #f4f7f9;
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 25px;
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.2s, color 0.2s;
        }
        .back-link:hover {
            text-decoration: none;
            background-color: #ecf0f1;
        }
        .chart-container {
            position: relative;
            min-height: 100px; /* –ß—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Å—Ö–ª–æ–ø—ã–≤–∞–ª—Å—è, –µ—Å–ª–∏ –≤ –Ω–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç */
            height: 40vh;
            width: 80vw;
            max-width: 500px;
            margin: 40px auto;
        }
        .stats {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        .stats-item:last-child { border-bottom: none; }
        .stats-item span { font-weight: bold; }
        .voters-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        .voters-table th, .voters-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        .voters-table th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        .voters-table tr:nth-child(even) { background-color: #f8f8f8; }
        .voters-table tr:hover { background-color: #f1f1f1; }
    </style>
</head>
<body>
    <a href="/api/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –æ–ø—Ä–æ—Å–æ–≤</a>

    <h1>{{ poll.title }}</h1>

    <div class="stats">
        <div class="stats-item">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤: <span>{{ total_votes }}</span></div>
        <div class="stats-item">–°—Ç–∞—Ç—É—Å: <span>{{ 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω' if poll.status else 'üî¥ –ó–∞–≤–µ—Ä—à–µ–Ω' }}</span></div>
        <div class="stats-item">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: <span>{{ poll.created_at.strftime('%d.%m.%Y %H:%M') }}</span></div>
    </div>

    <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤</h2>
    <div class="chart-container">
        <canvas id="pollChart"></canvas>
    </div>

    <h2>–°–ø–∏—Å–æ–∫ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö</h2>
    {% if participants %}
    <table class="voters-table">
        <thead>
            <tr>
                <th>–§–ò–û / –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                <th>–í—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç</th>
            </tr>
        </thead>
        <tbody>
            {% for participant in participants %}
            <tr>
                <td>{{ participant.user.full_name if participant.user else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</td>
                <td>{{ participant.option.option_text if participant.option else '–ù/–î' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>–ï—â–µ –Ω–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª.</p>
    {% endif %}

    <script>
        const ctx = document.getElementById('pollChart');
        const labels = {{ labels|safe }};
        const values = {{ values|safe }};

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≥–æ–ª–æ—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (labels && values && values.some(v => v > 0)) {
            const pollData = {
                labels: labels,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤',
                    data: values,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            };

            new Chart(ctx, {
                type: 'pie',
                data: pollData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }
                    }
                }
            });
        } else {
            // –ï—Å–ª–∏ –≥–æ–ª–æ—Å–æ–≤ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const container = document.querySelector('.chart-container');
            container.innerHTML = '<p style=\"text-align: center; color: #7f8c8d;\">–ï—â–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã.</p>';
        }
    </script>
</body>
</html>
